<div class="row wrapper border-bottom white-bg page-heading">
    <div class="col-lg-10">
        <h2>Account Stream Dashboard</h2>
    </div>
</div>

<div class="wrapper wrapper-content animated fadeInRight">

    <div class="row">
        <div class="col-sm-4">
            <div class="font-bold col-lg-5 m-t-sm">Account Type:</div>
            <select id="account-filter" class="category_filter col-lg-7">
                <option>All</option>
                <% Account::CATEGORY.each do |k,v| %>
                <option <% if params[:account] == v %> selected <% end %> ><%= v %></option>
                <% end %> 
            </select> 
        </div>
        <div class="col-sm-4 filter-space">
            <div class="font-bold col-lg-5 m-t-sm">Stream Type:</div>
            <select id="category-filter" class="category_filter col-lg-7">
                <option>All</option>
                <% Project::CATEGORY.each do |k,v|    %>
                <option <% if params[:category] == v %> selected <% end %> ><%= v %></option>
                <% end %> 
            </select> 
        </div>
    </div>
    
    <div class="row border-bottom white-bg dashboard-header">
            <!-- LEFT -->
            <div class="col-lg-5">
                <h4 class="m-l-md">Sort by: 
                    <select id="sort-type" class="metric_filter col-lg-8" data-placeholder="Select Type">
                        <option selected>Risk Score Today</option>
                        <option>Days Inactive</option>
                        <option>Engagement Last 7d</option>
                        <option>Risk / Engagement %</option>
                        <option>Total Open Risks</option>
                        <option>Total Overdue Tasks</option>
                    </select>
                </h4>
                <div id="left-chart" class="left-chart" style="height:1200px;"></div>
            </div>

            <!-- RIGHT -->
            <div class="col-lg-7" style="margin-top:45px;">
                <div id="account-data">
                    <div class="row" style="margin-top:50px;">
                        <h3>&larr; Click on a bar to see details about the account stream.</h3>
                    </div>
                </div>
            </div>
        </div>
</div>

<script>
    $(function () {

        $('#sort-type, #account-filter, #category-filter').change( function () {
            // Build URL for AJAX call for filtered data
            var url = "dashboard_data/" + encodeURIComponent($('#sort-type').val());
            var accountFilter = $('#account-filter').val() === "All" ? "" : "account=" + $('#account-filter').val();
            var categoryFilter = $('#category-filter').val() === "All" ? "" : "category=" + $('#category-filter').val();
            if (accountFilter || categoryFilter) {
                url += "?" + accountFilter;
                if (accountFilter && categoryFilter) {
                    url += "&";
                }
                url += categoryFilter;
            }
            $.getScript(url)
        });

        $('#left-chart').highcharts({
            chart: {
                type: 'bar'
            },
            title: {
                text: ''
            },
            xAxis: {
                categories: <%= @risk_scores.map(&:name).to_json.html_safe %>,
                crosshair: true
            },
            yAxis: {
                min: 0,
                max: 100,
                opposite: true,
                title: {
                    text: ''
                },
                gridLineWidth: 0
            },
            legend: {
                enabled: false
            },
            plotOptions: {
                series: {
                    cursor: 'pointer',
                    point: {
                        events: {
                            click: function () {
                                // console.log(this.options.id)
                                $.get("account_data/" + this.options.id, function (data) {
                                    $("#account-data").html(data);
                                    renderCharts(this.y);
                                })
                            }
                        }
                    }
                }   
            },
            credits: {
                enabled: false
            },
            series: [{
                name: 'Risk Score',
                data: [
                <% @risk_scores.each do |r| %>
                {
                    y: <%= r.score %>,
                    color: "<%= if r.score >= 80.0 
                            '#ed5565'
                        elsif r.score >= 60.0
                            '#FFA500'
                        else
                            '#A1C436'
                        end %>",
                    id: "<%= r.id %>"
                }, 
                <% end %>
                ],
            }, {
                name: 'Average',
                type: 'line',
                lineWidth: 2,
                color: '#7cb5ec',
                marker: { enabled: false, radius: 0 },
                data: <%= Array.new(@risk_scores.length, @average_risk_score).to_json.html_safe %>
            }]
        });

    });
</script>