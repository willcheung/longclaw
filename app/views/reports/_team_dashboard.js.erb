// Shared metric update code (left panel) between team_dashboard.html.erb & td_sort_data.js.erb
var chart = $('#left-chart').highcharts();
chart.xAxis[0].setCategories(<%= @data.map(&:name).to_json.html_safe %>, false);

//clear all old series
while(chart.series.length > 1) {
  chart.series[1].remove();
}

<% if @data.present? %>

  // Set the data
  <% if @metric == ReportsController::TEAM_DASHBOARD_METRIC[:activities_last14d] %>
    chart.series[0].hide();
    <% @categories.each.with_index do |c, i| %>
    chart.addSeries({
      name: "<%= c %>",
      color: "<%= highcharts_series_color(c) %>", //set color according to category
      //showInLegend: false,
      data: [ 
      <% @data.each do |d| %>
        <% m = d.y.find{|m| m.category == c} if d.y.present? %>  //find metric for this user
        {
          y: <%= (m.present? && m.num_activities.present?) ? m.num_activities : 0 %>,
          id: "<%= d.id %>"
        }, 
      <% end if @data.present? %> 
      ]
    }, false);
    <% end unless @categories.blank? %>
  <% elsif @metric == ReportsController::TEAM_DASHBOARD_METRIC[:time_spent_last14d] %>
    chart.series[0].hide();
    <% @categories.each do |c| %>
    chart.addSeries({
      name: "<%= c %>",
      color: "<%= highcharts_series_color(c) %>",  //set color according to category
      tooltip: {
        pointFormatter: function() {
          return '<span style="color:' + this.color + '">\u25CF</span>  ' + this.series.name + ': <b>' + convert_secs_to_ddhhmm(this.y) + '</b>';
        }
      },
      showInLegend: true,
      data: [ 
      <% @data.each do |d| %>
      {
        y: <%= d.y[c] %>,
        id: "<%= d.id %>"
      },
      <% end %> 
      ]
    }, false);
    <% end unless @categories.blank? %>
  <% else %>
    chart.series[0].show();
    chart.series[0].update({
      name: '<%= @metric.html_safe %>',
      color: '<%= highcharts_series_color() %>',
      data: [ <% @data.each do |d| %>
      {
        y: <%= d.y %>,
        id: "<%= d.id %>"
      },
      <% end %> ]
    }, false);
  <% end %>

  // Set/reset the axis labels and subtitles on chart
  <% if @metric == ReportsController::TEAM_DASHBOARD_METRIC[:time_spent_last14d] %>
    chart.yAxis[0].update({
      stackLabels: {
        enabled: true,
        formatter: function () {
          return convert_secs_to_ddhhmm(this.total);
        }
      }
    });
    chart.subtitle.update({
      text: '(in hh:mm)' 
    });
  <% else %>
    reset_labels_on_axis(chart.yAxis[0]);
    reset_subtitles_on_chart(chart);
  <% end %>

<% end %> // if @data.present? 

chart.yAxis[0].update( { tickInterval: <%= @metric_tick_interval %> });
//console.log("datamax=" + chart.yAxis[0].dataMax);
chart.setSize(undefined, 50 + Math.min(1150, <%= @data.size %> * 110)); //set graph height

// <% @data.each do |d| %>console.log("<%= d.name.html_safe %>: <%= d %>");<% end %>

// handle clicking on user label
$('.highcharts-xaxis-labels text tspan').click(function() {
    $.get("td_user_data/" + get_category_uuid($(this).text()), function (data) {
        $("#user-data").html(data);
        renderCharts(this.y);
    })
});

function get_category_uuid (catname) {
  var map = {
  <% @data.each do |d| %>
    "<%= d.name.html_safe %>": "<%= d.id %>",
  <% end %>
  };
  return map[catname];
}
