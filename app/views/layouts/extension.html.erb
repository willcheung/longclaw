<!DOCTYPE html>
<!-- Start of ContextSmith Chrome extension code -->
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ContextSmith | Enterprise Account Intelligence Platform</title>

    <!-- Include style per-controller - vendor plugins -->
    <%= stylesheet_link_tag "https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css" %>
    <%= stylesheet_link_tag "https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" %>

    <!-- Main css styles -->
    <%= stylesheet_link_tag 'application', media: 'all' %>

    <!-- Main javascript files -->
    <%= javascript_include_tag 'application' %>
    <%= javascript_include_tag "https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js" %>
    <%= javascript_include_tag "https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js" %>
    
    <%= csrf_meta_tags %>
</head>
<body>
    <!-- Wrapper-->
    <div id="wrapper" class="<%= params[:controller] %>.<%= params[:action] %>">

        <div id="page-wrapper" class="white-bg extension-sidebar">

            <!-- Navigation -->
            <div class="navbar-header border-bottom">
                <span style="width:150px; display:inline-block">
                    <a href="<%= root_path %>" target="_blank" class="navbar-brand">
                        <span class="clear">
                            <div class="block logo">&nbsp;</div>
                        </span>
                    </a>
                </span>
                <li class="dropdown" style="width:25px; height:40px; vertical-align:top; margin:5px 0; padding:0 3px;display:inline-block; border-left: 1px solid #EEE; float:right">
                    <img id="sfdc-icon" src="/assets/images/salesforce.png" style="width:0px;"/>
                    <a data-toggle="dropdown" class="dropdown-toggle" href="#"> 
                    <img src="/assets/images/salesforce.png" style="width:20px" title="<%= @salesforce_user.present? ? "Connected to Salesforce" : "Not connected to Salesforce" %>"/></a>
                    </a>
                    <span class="caret" style="margin-left:2px;display:inline"></span>
                    <ul class="dropdown-menu" style="width:200px; position:absolute; left:-175px; margin-top:6px">
                        <div style="margin:0.5em; line-height:2.5em">
                            <% if @salesforce_user.present? %>
                                <!-- SFDC user logged in -->
                                <li style="line-height: 1em"><strong><%= @salesforce_user.oauth_user_name %></strong></li>
                                <li><a href="<%= salesforce_disconnect_path(@salesforce_user.id) %>">(<i class='fa fa-sign-out'></i> Sign out)</a></li> 
                                <li class="divider"></li>

                                <li><button 
                                <%= "disabled " if !@enable_sfdc_refresh %>
                                id="salesforce-ext-acc-refresh" class="btn btn-sm btn-primary btn-outline sfdc-refresh" btnLabel="Refresh Accounts" style="font-size: 10px"><i class="fa fa-refresh"></i> Refresh Accounts</button> <i class="fa fa-question-circle text-primary"data-toggle="tooltip" data-placement="top" data-original-title="
                                <%= @enable_sfdc_refresh ? "Retrieve latest Accounts and fields from Salesforce." : "To retrieve the latest Accounts from Salesforce, please contact ContextSmith support or your ContextSmith administrator." %>
                                "></i></li>
                                
                                <li><button 
                                <%= "disabled " if !@enable_sfdc_refresh || !@linked_to_sfdc  %>
                                id="salesforce-ext-cont-import" class="btn btn-sm btn-primary btn-outline sfdc-refresh" btnLabel="Sync Contacts" style="font-size: 10px"><i class="fa fa-refresh"></i> Sync Contacts</button> <i class="fa fa-question-circle text-primary"data-toggle="tooltip" data-placement="top" data-original-title="
                                <%= @enable_sfdc_refresh ? "Synchronize Contacts with an e-mail from the linked Salesforce Account." : "To synchronize Contacts from Salesforce Accounts, please contact ContextSmith support or your ContextSmith administrator." %>
                                "></i></li>
                            <% else %>
                                <!-- SFDC user not logged in -->
                                <li>
                                <% if @enable_sfdc_login_and_linking %>
                                    <a href="<%= user_omniauth_auth_helper_path(provider: "salesforce", source: "chrome" ) %>" target="SignIn" onclick="openSignInPopup(this.href, this.target); return false;">Connect to Salesforce</a>
                                <% else %>
                                    <span style="color:lightgrey">Connect to Salesforce</span>
                                <% end %>
                                </li>
                            <% end %>
                        </div>
                    </ul>
                </li>
            </div>

            <% if @project %>
                <div style="">
                    <img class="pull-left m-r-sm" style="max-height:55px;max-width:55px" src="https://logo.clearbit.com/<%= @clearbit_domain %>"/>
                    <div>
                        <h3 class="m-t-sm m-l" style="margin-bottom: 9px" data-toggle="tooltip" data-placement="bottom" data-html="true" data-original-title="
                        <strong><%= Project::MAPPABLE_FIELDS_META["stage"] %></strong>: <%= @project.stage.nil? ? "-" : @project.stage %></br> 
                        <strong><%= Project::MAPPABLE_FIELDS_META["amount"] %></strong>: <%= (@project.amount.nil?) ? "-" : "$"+number_to_human(@project.amount) %></br>
                        <%= "<strong>People:</strong><br/> #{ (@members.collect{|m| get_full_name(m)}).sort_by{|m| m.upcase}.join('<br/>') } #{ ("<br/><span style='font-style: italic'>and " + (@all_members.size - @MEMBERS_LIST_LIMIT).to_s + " more...</span>") if @all_members.size > @MEMBERS_LIST_LIMIT } ".html_safe unless @all_members.size == 0 %>
                        "><a href="<%= project_path(@project) %>" target="_blank"><%= @project.name %></a> <% if @project.status != 'Active' %><small style="color:red">(Inactive)</small><% end %></h3>
                        <div class="text-mute-gray" style="font-size: 10px">
                            <span style="display:block"><strong>Owner:</strong>&nbsp;&nbsp;<%= @project.project_owner.present? ? get_full_name(@project.project_owner) : "(None)" %></span>

                            <strong>Linked to Salesforce:</strong>&nbsp;&nbsp;
                            <span>
                            <% if @project.salesforce_opportunity.nil? && @project.account.salesforce_accounts.empty? %>
                                <!-- No SFDC Accounts/Opportunities linked -->
                                <% if !@sfdc_accounts_exist %>
                                    <i class="fa fa-exclamation-triangle m-l-xs" data-toggle="tooltip" data-placement="top" data-original-title="
                                    <%= @enable_sfdc_login_and_linking ? "In the Salesforce menu above, log in and select the option to refresh the list of Salesforce Accounts!" : "To link and/or refresh Salesforce Accounts, please contact ContextSmith support or your ContextSmith administrator." %>
                                    "></i> <span>No Salesforce Accounts found! Refresh needed.</span>
                                <% else %>
                                    <!-- SFDC accounts found! -->
                                    <i class="fa fa-question-circle m-l-xs" data-toggle="tooltip" data-placement="top" data-original-title="
                                    <%= @salesforce_user.present? ? "Link Salesforce Accounts here." : (@enable_sfdc_login_and_linking ? "Click on Salesforce menu above and log in first!" : "To link and/or refresh Salesforce Accounts, please contact ContextSmith support or your ContextSmith administrator.") %>
                                    "></i>
                                    <% if @salesforce_user.present? && @enable_sfdc_login_and_linking %>
                                        <button id="show-link-account-form-btn" onclick="show_link_account_form_btn_clicked()">Not Linked. Click to link.</button>
                                        <div id="search-form-div" style="display:none">
                                            <%= form_tag("/link_salesforce_account/", :method => "post", id: "search-form", class: "fix-height", remote: false) do %>
                                                <div class="col-lg-16" style="width:12em;display: inline-block">
                                                  <input type="search" name="salesforce_id" id="salesforce-entity-search" class="contacts z-top salesforce-search" style="" placeholder="Search SFDC Accounts...">
                                                </div>
                                                <input name="account_id" type="hidden" value="<%= @project.account.id %>">     
                                                <div class="col-lg-2" style="margin:0px; padding-left:0px; vertical-align: text-bottom; display: inline-block">
                                                  <input type="submit" name="commit" value="Link" class="btn btn-primary btn-sm" style="padding-top:4px; height:2.7em; font-size:9px">
                                                </div>
                                            <%end%> <!-- End: form_tag do -->
                                        </div>
                                    <% else %>
                                        <!-- User has no permission to link -->
                                        Not linked.
                                    <% end %>
                                    <!-- End: SFDC accounts found -->
                                <% end %>
                                <!-- End: No SFDC Accounts/Opportunities linked -->
                            <% else %>
                                <!-- SFDC Accounts/Opportunities linked -->
                                <% if @project.salesforce_opportunity.nil? %>
                                    <% @project.account.salesforce_accounts.each_with_index do |sfa, i| %>
                                        <% if @salesforce_base_URL.present? %>
                                            <a href="<%= @salesforce_base_URL + "/" + sfa.salesforce_account_id %>" title="View in Salesforce" target="_blank"><%= sfa.salesforce_account_name %></a>
                                        <% else %>
                                            <%= sfa.salesforce_account_name %>
                                        <% end %>
                                        <% if @enable_sfdc_login_and_linking %>
                                            [<a href="/delete_salesforce_account/<%=sfa.id%>" data-method="delete">unlink</a>]
                                        <% end %>
                                        <%= "," if i < @project.account.salesforce_accounts.count - 1 %>
                                    <% end %> <!-- end: each_with_index do -->
                                <% else %>
                                    <% if @salesforce_base_URL.present? %>
                                        <a href="<%= @salesforce_base_URL + "/" + @project.salesforce_opportunity.salesforce_opportunity_id %>" title="View in Salesforce" target="_blank"><%= @project.salesforce_opportunity.name %></a>
                                    <% else %>
                                        <%= @project.salesforce_opportunity.name %>
                                    <% end %>
                                    <% if @enable_sfdc_login_and_linking %>
                                        [<a href="/delete_salesforce_opportunity/<%=@project.salesforce_opportunity.id%>" data-method="delete">unlink</i></a>]
                                    <% end %>
                                <% end %>
                            <% end %> <!-- End: No SFDC Accounts/Opportunities linked -->
                            </span>
                        </div>
                    </div>
                </div>

                <ul class="nav nav-tabs m-b-sm m-t-md">
                    <li role="presentation" class="<%= is_active_action('account') %>"><a href="<%= extension_account_path(internal: params[:internal], external: params[:external]) %>">Activities</a></li>
                    <li role="presentation" class="<%= is_active_action('alerts_tasks') %>"><a href="<%= extension_alerts_tasks_path(internal: params[:internal], external: params[:external]) %>"> To Do & Alerts</a></li>
                    <li role="presentation" class="<%= is_active_action('contacts') %>"><a href="<%= extension_contacts_path(internal: params[:internal], external: params[:external]) %>">Contacts</a></li>
                </ul>

            <% end %>

            <!-- Main view  -->
            <%= yield %>

        </div>

    </div>

    <%= yield :javascript %>

    <script>
        $('[data-toggle="tooltip"]').tooltip();

        $("#salesforce-entity-search").selectize({
            closeAfterSelect: true,
            valueField: 'id',
            labelField: 'name',
            searchField: ['name'],
            create: false,
            sortField: [
                {
                    field: 'name',
                    direction: 'asc'
                },
                {
                    field: '$score'
                }
            ],
            render: {
              item: function(item, escape) {
                return '<div>' +
                    (item.name ? '<span class="name">' + escape(item.name) + '</span>' : '') +
                    (item.account ? '<span class="account">' + escape(item.account) + '</span>' : '') +
                '</div>';
              },
              option: function(item, escape) {
                var label = item.name || item.account;
                var caption = item.name ? item.account : null;
                return '<div>' +
                    '<span class="label">' + escape(label) + '</span>' +
                    (caption ? '<span class="caption">' + escape(caption) + '</span>' : '') +
                '</div>';
              }
            },
            load: function (term, callback) {
              if (!term.length) return callback()
              // use # to search for projects by name
              // console.log(callback);
              $.getJSON( '/search/autocomplete_salesforce_account_name.json', { term: encodeURIComponent(term) } )
                .done( function (data) {
                  // console.log(data);
                  callback(data);
                })
                .fail( function () {
                  console.log("fail");
                  callback();
                })
              
            },
            onDropdownOpen: function ($dropdown) {
              // Manually prevent dropdown from opening when:
              // 1. There is no search term, or
              // 2. The search term does not begin with #
              // 3. At least one project has been selected already
              if (!this.lastQuery.length || this.items.length) {
                this.close();
              }
            },
            onBlur: function () {
              // Manually prevent input box from being cleared on blur
              this.setTextboxValue(this.lastQuery);
            }
        });

<% if @enable_sfdc_refresh %>
        $('.sfdc-refresh').click(function(){
            var entity_type;
            var buttonTxtStr = self.attr("btnLabel");
            var self = $(this);
            if ($(this).attr("id").includes("salesforce-ext-acc-refresh")) {  //clicked on 'Refresh Accounts'
                entity_type = "account";
                requestURL = "/salesforce/import/account";
            }
            // else if ($(this).attr("id").includes("salesforce-opp-refresh")) {
            //     entity_type = "project";
            //     requestURL = "/salesforce/import/project";
            // }
            else if ($(this).attr("id").includes("salesforce-ext-cont-import")) {  //clicked on 'Import Contacts'
                entity_type = "contact";
                requestURL = "/salesforce/sync";
            }
            else {
                return;
            }

            $.ajax(requestURL, {
                async: true,
                method: "POST",
                data: { "entity_type": entity_type },
                beforeSend: function () {
                    self.css("pointer-events", "none");
                    $("#" + self.attr("id") + " .fa.fa-refresh").addClass('fa-spin');
                },
                error: function(data) {
                    var res = JSON.parse(data.responseText);
                    self.addClass('error-btn-highlight');
                    alert("Encountered " + buttonTxtStr + " error!\n\n" + res.error);
                },
                statusCode: {
                    500: function() {
                        //self.css("margin-left","0px");
                        self.html("<i class='fa fa-exclamation'></i> Salesforce query error");
                    },
                    503: function() {
                        //self.css("margin-left","0px");
                        self.html("<i class='fa fa-exclamation'></i> Salesforce connection error");
                    },
                },
                complete: function() {
                    self.css("pointer-events", "auto");
                    $("#" + self.attr("id") + " .fa.fa-refresh").removeClass('fa-spin');
                    location.reload();
                }
            });
        });
<% end %>

        var popupWindowRef = null;
        var openSignInPopup = function (strUrl, strTarget) {
            var strOptions = "width=700,height=700";
            if (popupWindowRef == null || popupWindowRef.closed) {
                popupWindowRef = window.open(strUrl, strTarget, strOptions);
                // Poll popup window, refresh this page when it is closed
                var pollPopupClosed = window.setInterval(function() {
                    if (popupWindowRef.closed) {
                        window.clearInterval(pollPopupClosed);
                        window.location.reload(true)
                    }
                }, 200);
            }
            else {
                popupWindowRef.focus();
            }
        };

        // Button to show the form to link SFDC account
        function show_link_account_form_btn_clicked () {
            $("#show-link-account-form-btn").hide();
            $("#search-form-div").show();
        }

        // Disable the "Link" submit button after clicking it
        $("#search-form").submit(function () {
            $("#search-form .btn").attr("disabled", true);
            return true;
        });
    </script>

    <%= javascript_include_tag "https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js" %>
    <%= javascript_include_tag "https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js" %>

    <% if ENV["RAILS_ENV"] == 'production' %>
    <!-- Google Analytics -->
        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

          ga('create', '<%= ENV['GA_ID'] %>', 'auto');
          ga('send', 'pageview');
        </script>
    <% end %>

    <!-- TODO: Remove this hardcoded CSS workaround -->
    <style>
        .dropdown-menu {
            border: 1px solid #aaa;
            z-index: 2003;
        }
        .selectize-input {
            height: 1.75em;
            display: inline-block;
            padding-top: 0em;
            overflow: auto;
        }
        .selectize-input input, .selectize-input span {
            padding-top: 0em;
            font-size: 10px;
            //text-overflow: ellipsis;
        }
        .selectize-control.multi .selectize-input.has-items {
            padding-top: 0em;
        }
        .selectize-control.multi .selectize-input.has-items div {
            padding-top: 0em;
            padding-bottom: 0em;
        }
        .btn:disabled {
            color: #DDD;
        }
    </style>
</body>
</html>
<!-- End of ContextSmith Chrome extension code -->
