
<div class="wrapper wrapper-content animated fadeInRight">
    <div class="row">
        <div class="col-lg-4">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h2>Most Active (7d)</h2>
                </div>
                <!-- <i class="fa fa-question-circle m-l-xs m-t-xs" data-toggle="tooltip" data-placement="top" data-original-title="Opportunities with most activity during the last 7 days."></i> -->
                <div id="chart-left" class="opp-chart"></div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h2>Least Active (7d)</h2>
                </div>
                <!-- <i class="fa fa-question-circle m-l-xs m-t-xs" data-toggle="tooltip" data-placement="top" data-original-title="Opportunities with least activity during the last 7 days."></i> -->
                <div id="chart-center" class="opp-chart"></div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h2>Most Open Alerts & Tasks</h2>
                </div>
                <!-- <i class="fa fa-question-circle m-l-xs m-t-xs" data-toggle="tooltip" data-placement="top" data-original-title="Opportunities with the most open Alerts & Tasks"></i> -->
                <div id="chart-right" class="opp-chart"></div>
            </div>
        </div>
    </div>

    <!-- Metrics -->
    <div class="row ibox float-e-margins">
        <div class="col-lg-12">
            <div class="ibox-title">
                <h2>My Alerts & Tasks</h2>
            </div>
            <div class="ibox-content">
                <!-- <h2>Open and Alerts</h2> -->
                    <div class="col-lg-12 m-b-md">
                        <% if @open_total_tasks.empty? %>
                            <p>Great, no open tasks on your Opportunities.</p>
                        <% else %>
                            <%= render "notifications/table", :notifications => @open_total_tasks %>
                        <% end %>
                    </div>
                <!-- <h2>Tasks Overdue / Due Today</h2>
                    <div class="col-lg-12 m-b-md">
                        < % if @overdue_tasks.empty? %>
                            <p>Hooray, no tasks due immediately!</p>
                        < % else %>
                            < %= render "notifications/table", :notifications => @overdue_tasks %>
                        < % end %>
                    </div> -->
                <!-- <h2>Open Tasks</h2>
                     <div class="col-lg-12 m-b-md">
                        < % if @open_tasks_not_overdue.empty? %>
                            <p>Nothing here, nice.</p>
                        < % else %>
                            < %= render "notifications/table", :notifications => @open_tasks_not_overdue %>
                        < % end %>
                    </div> -->
                <p><a href="<%= notifications_path %>/?type=incomplete&assignee=me">See more Alerts & Tasks &raquo;</a>
            </div>
        </div>
    </div>

    <div class="row ibox float-e-margins">
        <div class="col-lg-12">
            <div class="ibox-title">
                <table>
                    <tbody>
                        <tr>
                            <td><h2>My Opportunities<h2></h2>
                            <td>&nbsp;<i class="fa fa-question-circle m-l-xs m-t-xs" data-toggle="tooltip" data-placement="top" data-original-title="You own or to which you are subscribed."></i></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="ibox-content">
                <table class="table table-hover responsive no-wrap" id="projects-table" cellspacing="0" width="100%">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th><%= Project::MAPPABLE_FIELDS_META["stage"] %></th>
                            <th><%= Project::MAPPABLE_FIELDS_META["amount"] %></th>
                            <th>Owner</th>
                            <th></th>
                            <th>Days to Close</th>
                            <th>Open Alerts & Tasks</th>
                            <th>Last 7d Activity</th>
                            <th>Days Inactive</th>
                            <th>Next Meeting</th>
                            <th></th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        <% @projects.each do |p| %>
                            <tr>
                                <td>
                                    <div><a href="<%= project_path(p) %>"><%= p.name %></a></div>
                                    <div class="m-t-xs"><small><a class="link-muted" href="<%= account_path(p.account) %>"><%= p.account.name %></a></small></div>
                                </td>
                                <td style="width: 120px"><%= (p.stage.nil? or p.stage.empty?) ? "-" : p.stage %></td>
                                <td style="width: 120px"><%= (p.amount.nil?) ? "-" : "$"+number_to_human(p.amount) %></td>
                                <td><div><%= get_full_name(p.project_owner) %></div></td>
                                <td style="width: 40px"><span
                                <% all_members = p.users + p.contacts %>
                                <% members = all_members.first(@MEMBERS_LIST_LIMIT) %>
                                <%= " data-toggle=\"tooltip\" data-placement=\"right\" data-html=\"true\" data-original-title=\"<strong>People:</strong><br/> #{ (members.collect {|m| get_full_name(m)}).sort_by{|m| m.upcase}.join('<br/>') } #{ ("<br/><span style='font-style: italic'>and " + (all_members.size - @MEMBERS_LIST_LIMIT).to_s + " more...</span>") if all_members.size > @MEMBERS_LIST_LIMIT } \"".html_safe unless all_members.size == 0 %>
                                ><i class="fa fa-users" style="color:#888"></i> <%= all_members.size %></span></td>
                                <!-- <td style="text-align: center;" class="< %= risk_color(@risk_scores[p.id]) %>">< %= @risk_scores[p.id] %></td> -->
                                <td style="text-align:center;" class=""><%= @days_to_close[p.id].nil? ? "-" : @days_to_close[p.id].to_s %></td>
                                <td style="text-align:center;" class="<%= @open_risk_count[p.id] > 0 ? 'text-danger' : '' %>"><%=@open_risk_count[p.id].to_s %></td>
                                <td data-sparkline="<%= @sparkline[p.id].join(', ') %>; column"></td>

                                <td style="text-align:center"><%= @project_days_inactive[p.id].nil? ? "-" : @project_days_inactive[p.id] %></td>

                                <% next_meeting = @next_meetings[p.id].nil? ? "-" : @next_meetings[p.id].strftime('%l:%M%p on %B %-d') %>
                                <% next_meeting_ts = @next_meetings[p.id].nil? ? 0 : @next_meetings[p.id].to_i %>
                                <td data-order="<%= next_meeting_ts %>" style="text-align:center"><%= next_meeting %></td>
                                
                                <td><% if p.is_public %>
                                        <span class="label label-default pull-right">Public</span>
                                    <% else %>
                                        <span class="label label-warning pull-right">Private</span>
                                    <% end %>
                                </td>
                                <td style="width: 120px"> 
                                    <span data-toggle="tooltip" data-placement="left" data-original-title="Subscribe to daily updates and alerts." data-delay='{"show":"300"}'>
                                    <% if p.daily %>
                                        <%= link_to "<i class=\"fa fa-check\"></i> Daily".html_safe, project_project_subscriber_path(project_id: p.id, user_id: current_user.id) + "?type=daily", remote: true, method: :delete, id: "project-index-unfollow-daily-#{p.id}", class: "block m-b-xs", title: "Following daily" %>
                                    <% else %>
                                        <%= link_to "<i class=\"fa fa-bell-o\"></i> Daily".html_safe, project_project_subscribers_path(project_id: p.id, user_id: current_user.id) + "&type=daily", remote: true, method: :post, id: "project-index-follow-daily-#{p.id}", class: "block m-b-xs", title: "Follow daily" %>
                                    <% end %>
                                    </span>
                                    <span data-toggle="tooltip" data-placement="left" data-original-title="Subscribe to weekly updates and alerts." data-delay='{"show":"300"}'>
                                    <% if p.weekly %>
                                        <%= link_to "<i class=\"fa fa-check\"></i> Weekly".html_safe, project_project_subscriber_path(project_id: p.id, user_id: current_user.id) + "?type=weekly", remote: true, method: :delete, id: "project-index-unfollow-weekly-#{p.id}", class: "block m-b-xs", title: "Following weekly" %>
                                    <% else %>
                                        <%= link_to "<i class=\"fa fa-bell-o\"></i> Weekly".html_safe, project_project_subscribers_path(project_id: p.id, user_id: current_user.id) + "&type=weekly", remote: true, method: :post, id: "project-index-follow-weekly-#{p.id}", class: "block m-b-xs", title: "Follow weekly" %>
                                    <% end %>
                                    </span>
                                </td>
                            </tr>
                        <% end %>
                    </tbody>
                    <tfoot>
                        <tr>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

   
</div>

<%= javascript_include_tag "notifications_table" %>

<script type="text/javascript">
    $(document).ready(function() {

        $('#chart-left').highcharts({
            chart: {
                type: 'bar'
            },
            title: {
                text: ''
            },
            // subtitle: {
            //     text: ' ',
            //     align: 'center',
            //     y: 40
            // },
            xAxis: {
                max: undefined,
                crosshair: true,
                labels: {
                    formatter: function () {
                        // this.value = [project_name, deal_size, close_date]
                        return "<b>" + this.value[0] + "</b><br/>" + this.value[1] + (this.value[1] != "" && this.value[2] != "" ? ", " : "" ) + this.value[2];
                    }
                }
            },
            yAxis: {
                min: 0,
                // max: 100,
                opposite: true,
                title: {
                    text: ''
                },
                gridLineWidth: 0,
                labels: {
                    enabled: false
                },
                stackLabels: {
                    enabled: true
                }
            },
            tooltip: {
                headerFormat:  '',
                pointFormatter: function() {
                    // this.category = [project_name, deal_size, close_date]
                    return '<span style="font-size: 10px">' + this.category[0] + '</span><br/><span style="color:' + this.color + '">\u25CF</span>  ' + this.series.name + ': <b>' + this.y + '</b>';
                }
            },
            legend: {
              enabled: false,
              // verticalAlign: 'top',
              // itemStyle: {
              //     fontWeight: 'light',
              //     fontSize: 12         
              // }
            },
            plotOptions: {
                series: {
                    stacking: 'normal',
                    cursor: 'pointer',
                    pointWidth: 33,
                    //maxPointWidth: 75,
                    point: {
                        events: {
                            click: function () {
                                window.location.assign("/projects/"+ this.options.id);
                                //window.open("/projects/"+ this.options.id);
                            }
                        }
                    }
                },
                allowPointSelect: false
            },
            credits: {
                enabled: false
            }
        });

        $('#chart-center').highcharts({
            chart: {
                type: 'bar'
            },
            title: {
                text: ''
            },
            // subtitle: {
            //     text: ' ',
            //     align: 'center',
            //     y: 40
            // },
            xAxis: {
                max: undefined,
                crosshair: true,
                labels: {
                    formatter: function () {
                        // this.value = [project_name, deal_size, close_date]
                        return "<b>" + this.value[0] + "</b><br/>" + this.value[1] + (this.value[1] != "" && this.value[2] != "" ? ", " : "" ) + this.value[2];
                    }
                }
            },
            yAxis: {
                min: 0,
                // max: 100,
                opposite: true,
                title: {
                    text: ''
                },
                gridLineWidth: 0,
                labels: {
                    enabled: false
                },
                stackLabels: {
                    enabled: true
                }
            },
            tooltip: {
                headerFormat:  '',
                pointFormatter: function() {
                    // this.category = [project_name, deal_size, close_date]
                    return '<span style="font-size: 10px">' + this.category[0] + '</span><br/><span style="color:' + this.color + '">\u25CF</span>  ' + this.series.name + ': <b>' + this.y + '</b>';
                }
            },
            legend: {
              enabled: false,
              // verticalAlign: 'top',
              // itemStyle: {
              //     fontWeight: 'light',
              //     fontSize: 12         
              // }
            },
            plotOptions: {
                series: {
                    stacking: 'normal',
                    cursor: 'pointer',
                    pointWidth: 33,
                    //maxPointWidth: 75,
                    point: {
                        events: {
                            click: function () {
                                window.location.assign("/projects/"+ this.options.id);
                            }
                        }
                    }
                },
                allowPointSelect: false
            },
            credits: {
                enabled: false
            }
        });

        $('#chart-right').highcharts({
            chart: {
                type: 'bar'
            },
            title: {
                text: ''
            },
            // subtitle: {
            //     text: ' ',
            //     align: 'center',
            //     y: 40
            // },
            xAxis: {
                max: undefined,
                crosshair: true,
                labels: {
                    formatter: function () {
                        // this.value = [project_name, deal_size, close_date]
                        return "<b>" + this.value[0] + "</b><br/>" + this.value[1] + (this.value[1] != "" && this.value[2] != "" ? ", " : "" ) + this.value[2];
                    }
                }
            },
            yAxis: {
                min: 0,
                // max: 100,
                opposite: true,
                title: {
                    text: ''
                },
                gridLineWidth: 0,
                labels: {
                    enabled: false
                },
                stackLabels: {
                    enabled: true
                }
            },
            tooltip: {
                headerFormat:  '',
                pointFormatter: function() {
                    // this.category = [project_name, deal_size, close_date]
                    return '<span style="font-size: 10px">' + this.category[0] + '</span><br/><span style="color:' + this.color + '">\u25CF</span>  ' + this.series.name + ': <b>' + this.y + '</b>';
                }
            },
            legend: {
              enabled: false,
              // verticalAlign: 'top',
              // itemStyle: {
              //     fontWeight: 'light',
              //     fontSize: 12         
              // }
            },
            plotOptions: {
                series: {
                    stacking: 'normal',
                    cursor: 'pointer',
                    pointWidth: 33,
                    //maxPointWidth: 75,
                    point: {
                        events: {
                            click: function () {
                                window.location.assign("/projects/"+ this.options.id);
                            }
                        }
                    }
                },
                allowPointSelect: false
            },
            credits: {
                enabled: false
            }
        });

        <%= render partial: "home/top_dashboard.js" %>

        // handle clicking on opportunity label
        $('.highcharts-xaxis-labels text').click(function() {
            var clicked_pid = get_category_uuid($(this).children(0)[0].firstChild.data);
            if (clicked_pid)
              window.location.assign("/projects/"+ clicked_pid);
        });

        function get_category_uuid (catname) {
            // console.log("Finding proj: " + catname);
            var map = {
                <% @visible_projects.each do |d| %>
                  "<%= d.name.html_safe %>": "<%= d.id %>",
                <% end %>
            };
            return map[catname];
        }
    });
</script>
