<div class="row wrapper border-bottom white-bg page-heading">
    <div class="col-lg-10">
        <h2>Streams</h2>
        <ol class="breadcrumb">
            <li>
                <a href="<%= root_path %>">Home</a>
            </li>
            <li class="active">
                <strong>Streams</strong>
            </li>
        </ol>
    </div>
    <div class="col-lg-2">
        <%= link_to '+ New Stream', '#new_project_modal', 'data-toggle' => 'modal', 'class' => 'btn btn-primary m-t-lg' %>
    </div>
</div>

<div class="wrapper wrapper-content animated fadeInUp">
    <div class="row">
        <div class="col-lg-2 filter-group">
          <div class="font-bold m-b-xs">Filter:</div>
          <select class="category_filter col-lg-12" data-placeholder="Select Type">
            <option value="0"></option>
            <% Project::CATEGORY.each{|k,v|    %>
            <option value="<%=v %>"   <% if params[:type] == v  %> selected   <% end %>  ><%=v %></option>
            <% } %>
          </select>
        </div>
        <div class="col-lg-6 bulk-group">
            <div class="font-bold m-b-xs">Bulk Operation:</div>
            <button type="button" class="btn btn-sm btn-white" id="bulk-delete" disabled> Delete </button>
            <select class="category_box col-sm-3" data-placeholder="Change Type" id="bulk-type" disabled>
              <option value="0"></option>
              <% Project::CATEGORY.each{|k,v| %>
              <option value="<%=v %>" ><%=v %></option>
               <% } %>
            </select>
            <select class="owner_box col-sm-3" data-placeholder="Change Owner" id="bulk-owner" disabled>
              <option value="0"></option>
              <% @owners.each do |u|    %>
              <option value="<%=u.id %>" ><%= "#{u.first_name} #{u.last_name}" %></option>
               <% end %>
            </select>
        </div>
    </div>

    <div class="row">
        <div class="col-sm-12 m-t-md">
            <% if @projects.empty? %>
                <div class="text-center m-t-lg">
                    <h3>No streams found. Did you filter them out?</h3>
                </div>
            <% else %>
                <div class="ibox float-e-margins">
                    <div class="ibox-content">
                        <table class="table table-hover responsive no-wrap" id="projects-table" cellspacing="0" width="100%">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th>Stream</th>
                                    <th>Type</th>
                                    <th>Owner</th>
                                    <th></th>
                                    <th></th>
                                    <th>Risk Score</th>
                                    <th>Sentiment</th>
                                    <th>Open Risks</th>
                                    <th>Status</th>
                                    <th>Inactive Days</th>
                                    <th></th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                <% @projects.each do |account,projects| %>
                                    <% projects.each do |p| %>
                                        <tr style="height:70px;">
                                            <td><input type="checkbox" class="bulk-project" value="<%=p.id  %>"</td>
                                            <td>
                                                <div><a href="<%= project_path(p) %>"><%= p.name %></a></div>
                                                <div class="m-t-xs"><small><a class="link-muted" href="<%= account_path(account) %>"><%= account.name %></a><small></div>
                                            </td>
                                            <td style="width: 120px"><%= best_in_place p, :category, :as => :select, :collection => Project::CATEGORY, :class => 'btn btn-outline btn-xs fa-caret-down' %></td>
                                            <td>
                                                <%= best_in_place p, :owner_id, :as => :select, :collection => @users_reverse, :place_holder => '(none)', :activator => "#project-#{p.id}-owner-activator" %>
                                                <i id="project-<%= p.id %>-owner-activator" class="fa fa-caret-down bip_activator text-mute-gray"></i>
                                            </td>
                                            <td style="width: 40px"><span data-toggle="tooltip" data-placement="right" data-html="true" data-original-title="<%= ((p.users+p.contacts).collect {|u| get_full_name(u)}).join('<br>') %>"><i class="fa fa-users" style="color:#888"></i> <%= (p.users.size + p.contacts.size) %></span></td>
                                            <td style="width: 40px"><span data-toggle="tooltip" data-placement="right" data-html="true" data-original-title="<%= (p.activity_count) %> conversations"><i class="fa fa-comments" style="color:#888"></i> <%= (p.activity_count) %></span></td>
                                            <td style="text-align: center;" class="<%= risk_color(@risk_scores[p.id]) %>"><%= @risk_scores[p.id] %></td>
                                            <td style="text-align: center;" class="<%= risk_color(@sentiment_scores[p.id]) %>"><%= @sentiment_scores[p.id] %></td>
                                            <td style="text-align: center;" class="<%= @open_risk_count[p.id] > 0 ? 'text-danger' : '' %>"><%=@open_risk_count[p.id].to_s %></td>
                                            <td style="text-align:center"><div class="index-circle rag-circle<%=@rag_status[p.id]%>"></div><div style="display:none;"><%=@rag_status[p.id].to_i%></div></td>
                                            <td style="text-align:center"><%= @project_last_activity_date[p.id].nil? ? "" : ((Time.current - @project_last_activity_date[p.id])/86400).to_i %></td>
                                            <td><% if !p.is_public %>
                                                    <span class="label label-warning pull-right">Private</span>
                                                <% else %>
                                                    <span class="label label-default pull-right">Public</span>
                                                <% end %>
                                            </td>
                                            <td style="width: 80px">
                                                <span data-toggle="tooltip" data-placement="left" data-original-title="Follow to receive daily updates and alerts." data-delay='{"show":"300"}'>
                                                    <% if p.subscribers.map(&:user_id).include?(current_user.id) %>
                                                        <%= link_to "<i class=\"fa fa-check\"></i> Following".html_safe, project_project_subscriber_path(project_id: p.id, user_id: current_user.id), remote: true, method: :delete, id: "follow-#{p.id}" %>
                                                    <% else %>
                                                        <%= link_to "<i class=\"fa fa-bell-o\"></i> Follow ".html_safe, project_project_subscribers_path(project_id: p.id, user_id: current_user.id), remote: true, method: :post, id: "follow-#{p.id}" %>
                                                    <% end %>
                                                </span>
                                            </td>
                                        </tr>

                                        <script>
                                        $("#sparkline-<%= p.id.split('-').first %>").sparkline(<%= @metrics[p.id] %>, {
                                            type: 'bar',
                                            height: '20',
                                            barWidth: 12,
                                            barSpacing: 2,
                                            barColor: '#5DA5DA',
                                            zeroAxis: false,
                                            zeroColor: '#ed5565'
                                        });
                                        </script>
                                    <% end %>
                                <% end %>
                            </tbody>
                        </table>
                    </div>
                </div>
            <% end %>
        </div>
    </div>

</div>

<%= render 'projects/modal', modal_id: 'new_project_modal' %>

<script>
$('[data-toggle="tooltip"]').tooltip();
</script>
