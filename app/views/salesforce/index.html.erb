<div class="row">
  <div class="col-lg-9">
    <div class="wrapper animated fadeInUp">
      <div class="panel blank-panel">
        <div class="panel-heading">
          <ul class="nav nav-tabs">            
            <% if @projects.empty? %>
              <div class="text-center m-t-lg">
                <% if @isconnect %>
                  <h3>Cannot find your ContextSmith Stream</h3>
                <% else %>
                  <h3>Not connected to any ContextSmith Account</h3>
                <% end  %>
              </div>
            <% else %>
        	    <% @projects.each do |p| %>
                <li class="nav-tab <% if p.id== @project.id %> active <% end %>"><a id="newsfeed-link" href="/salesforce/?id=<%=@salesforce_id %>&pid=<%=p.id%> " class="white-bg"><i class="fa fa-comments"></i> <%=p.name %></a>
                </li>
              <% end %>
            <% end %>
          </ul>
        </div>
      </div>
     
    <% if !@projects.empty? %>
      <!-- Form -->
      <div class="col-lg-12">
        <div class="col-lg-1">
        </div>

        <div class="row header-box projects-box white-bg col-lg-8">
          <div class="col-xs-3" style="padding-top: 10px;">
              <div class="metric <%= @project_risk_score > 95.0 ? "text-danger" : "text-success" %>">
                <div class="metric-title">
                  <h5><%= @project_risk_score > 95.0 ? "High" : "Low" %> Risk</h5>
                </div>
                <div class="metric-content">
                  <h3><%= @project_risk_score %>%</h3>
                </div>
              </div>
            </div>
            <div class="col-xs-3" style="padding-top: 10px;">
              <div class="metric text-primary">
                <div class="metric-title">
                  <h5>Last Touch By</h5>
                </div>
                <div class="metric-content">
                  <h3><%= @project_last_touch_by %></h3>
                </div>
              </div>
            </div>
            <div class="col-xs-3"  style="padding-top: 10px;">
              <div class="metric">
                <div class="metric-title">
                  <h5>Last Activity</h5>
                </div>
                <div class="metric-content">
                  <h3><%= @project_last_activity_date ? time_ago_in_words(@project_last_activity_date) + " ago" : "--" %></h3>
                </div>
              </div>
            </div>
            <div class="col-xs-3"  style="padding-top: 12px;">
              <div class="metric">
                <div class="metric-title">
                  <h5></h5>
                </div>
                <div class="metric-content">
                  <h3>
                  <% if @project.subscribers.map(&:user_id).include?(current_user.id) %>
                    <%= link_to "<i class=\"fa fa-check\"></i> Following".html_safe, project_project_subscriber_path(project_id: @project.id, user_id: current_user.id), remote: true, method: :delete, id: "follow-#{@project.id}", class: "btn btn-primary btn-sm btn-outline m-l-md m-t-n-sm" %>
                  <% else %>
                     <%= link_to "<i class=\"fa fa-bell-o\"></i> Follow ".html_safe, project_project_subscribers_path(project_id: @project.id, user_id: current_user.id), remote: true, method: :post, id: "follow-#{@project.id}", class: "btn btn-primary btn-sm btn-outline m-l-md m-t-n-sm" %>
                  <% end %>
                  </h3>
                </div>
              </div>
            </div>
            <div class="salesforce-comment-post" >
            </div>
        
            <div id="add-note-form" class="m-t">
              <%= render 'activities/form', :project_id => @project.id %>  
            </div>

          </div> 
        </div>   

        <!-- Filter Section -->   
        <div class="col-lg-7 col-lg-offset-1">   
          <%= render 'activities/filter', type: 'salesforce' %>   
        </div>


        <!-- Activity Section -->   
        <div id="newsfeed" class="col-lg-12">
          <div class="row col-lg-1">
          </div>
          <div class="row col-lg-8">
            <div id="vertical-timeline" class="vertical-container light-timeline m-t">
              <% @activities_by_month.each do |month, activities| %>
                <div class="vertical-timeline-month" data-myvalue='month'>
                  <h3 class="p-xs m-l-n-sm gray-bg"><%= month %></h3>
                </div>
                          
                <% activities.each do |a| %>
                  <%= render 'activities/timeline_block', a: a %>
                <% end %>
              <% end %>
            </div>
          </div>  
        </div>
      <% end %>
    </div>
  </div>
</div>


<%= javascript_include_tag 'activity_filter' %>
<script>

$(function () {
  Highcharts.setOptions({                                            
  // This is for all plots, change Date axis to local timezone
    global : {
      // timezoneOffset: -7 * 60,
      useUTC : false
    },
    lang: {
        resetZoom: "Clear date filter"
    }
  });
  $('#time-filter-highcharts').highcharts({
    chart: {
        events:{
          load: function(event) {
            var extremes = this.yAxis[0].getExtremes();
            this.yAxis[0].setExtremes(0, extremes.dataMax);
        },
          selection: function(event) {

            if(event.xAxis !=null){
              g_minDate = event.xAxis[0].min/1000;
              g_maxDate = event.xAxis[0].max/1000;
              console.log('----------------');
              console.log(g_minDate);
              console.log(g_maxDate);
              console.log('----------------');
              applyFilter();

              // activityTimeFilter(event.xAxis[0].min/1000,event.xAxis[0].max/1000);

            }
            else{
              // console.log("selection: reset");
              // activityTimeFilterReset();
              g_minDate = 0; 
              g_maxDate = 0;
              applyFilter();
            }

          }

        },
        zoomType: 'x',
        backgroundColor: '#f3f3f4'
    },
    credits: {
        enabled: false
    },
    title: {
        text: ''
    },
    // subtitle: {
    //     text: document.ontouchstart === undefined ?
    //             'Click and drag in the plot area to zoom in' : 'Pinch the chart to zoom in'
    // },
    xAxis: {
        type: 'datetime'
    },
    yAxis: {
        title: { text: '' },
        labels: { enabled: false },
        gridLineWidth: 0,
        minorGridLineWidth: 0
    },
    legend: {
        enabled: false
    },
    plotOptions: {
        area: {
            fillColor: {
                linearGradient: {
                    x1: 0,
                    y1: 0,
                    x2: 0,
                    y2: 1
                },
                stops: [
                    [0, Highcharts.getOptions().colors[0]],
                    [1, Highcharts.Color(Highcharts.getOptions().colors[0]).setOpacity(0).get('rgba')]
                ]
            },
            marker: {
                radius: 2
            },
            lineWidth: 1,
            states: {
                hover: {
                    lineWidth: 1
                }
            },
            threshold: null
        }
    },

    series: [{
        type: 'column',
        name: 'Activity Count',
        data: [ 
                <% counter = 0  %>
                <% @activities_by_date.each do |a| %>
                    <% if (counter < @activities_by_date.length)  %>
                      <% counter = counter + 1  %>
                      <%='['+a.utc_milli_timestamp.inspect + ','+ a.count.inspect+'],' %>
                    <% else  %>
                      <%='['+ +a.utc_milli_timestamp.inspect + ','+ a.count.inspect+']' %>
                    <% end %>
                  
                <% end %>
              ]                
    }]
  });
});
  
$(document).ready(function(){
  $('.comment_category').chosen({ disable_search: false, allow_single_deselect: true, width: $('#timeline-filters').width()/2-40 + 'px'});
  $('.user_filter').chosen({disable_search: false, allow_single_deselect: true, width: $('#timeline-filters').width()/2-40 + 'px'});

  $('#timeline-filters').hide();
});

</script>

<style>
.salesforce-comment-post:after {
  content: "";
  display: table;
  clear: both;
}
</style>

