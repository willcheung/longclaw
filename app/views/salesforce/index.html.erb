<div class="row">
  <div class="col-lg-9">
    <div class="wrapper animated fadeInUp">
      <div class="panel blank-panel">
        <div class="panel-heading">
          <ul class="nav nav-tabs">
            <% if @project.nil? %>
              <div class="text-center m-t-lg">
                <h3>Invalid project identifier</h3>
              </div>
            <% elsif @streams_mapped.blank? %>
              <div class="text-center m-t-lg">
                <% if !@is_mapped_to_CS_account %>
                  <h3>Not connected to any ContextSmith Account</h3>
                <% else %>
                  <h3>No project in this account</h3>
                <% end  %>
              </div>
            <% else %>
              <!-- Show links to all connected CS streams at the top -->
        	    <% @streams_mapped.each_with_index do |p, i| %>
                <% if p.id == @project.id %> 
                  <span style="font-size: 15px; font-weight: bold"><%=p.name%></span>
                <% else %>
                  <span style="font-size: 15px; text-decoration: underline">
                  <a id="project_cluster" href="/salesforce/?id=<%=@salesforce_id %>&pid=<%=p.id%> "><%=p.name%></a></span>
                <% end %>
                &nbsp;&nbsp;<% if i < @streams_mapped.size - 1 %>|<%end %>&nbsp;&nbsp;
                </span>
              <% end %>
            <% end %>
          </ul>
        </div>
      </div>
     
    <% if @project.present? && @streams_mapped.present? %>
      <!-- Form -->
      <div class="col-lg-12" style="padding-top: 20px">
        <!--<div class="col-lg-1">
        </div>-->
        <div class="row header-box projects-box white-bg col-lg-8">
          <div class="col-xs-12" style="padding-top: 10px;">
            <div class="row">
                <div class="col-xs-4">
                    <div class="metric <%= risk_color(@project_risk_score) %>">
                        <div class="metric-title" align="center">
                            <h4>Risk Score</h4>
                        </div>
                        <div class="metric-content" align="center">
                            <h2><%= @project_risk_score %></h2>
                        </div>
                    </div>
                </div>
                <div class="col-xs-4">
                    <div class="metric text-danger">
                        <div class="metric-title" align="center">
                            <h4>Open Smart Tasks</h4>
                        </div>
                        <div class="metric-content" align="center">
                            <h2><%= @project_open_tasks_count %></h2>
                        </div>
                    </div>
                </div>
                <div class="col-xs-4">
                    <div class="metric">
                        <div class="metric-title" align="center">
                            <h4>Status</h4>
                        </div>
                        <div class="metric-content" align="center">
                          <div class="large-circle rag-circle<%=@project_rag_status%>"></div>
                        </div>
                    </div>
                </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Render by Activity, key, smart task, insight -->

      <div class="row">
        <div class="col-lg-12" style="padding-top: 20px;">
            <ul class="nav nav-tabs">
                  <li class="nav-tab"><a id="newsfeed-link" href="/salesforce/?id=<%=@salesforce_id %>&pid=<%=@project.id%>&actiontype=show" class="white-bg"><i class="fa fa-comments"></i> Activities</a></li>
                  <li class="nav-tab"><a id="pinned-link" href="/salesforce/?id=<%=@salesforce_id %>&pid=<%=@project.id%>&actiontype=pinned_tab" class="white-bg"><i class="fa fa-thumb-tack"></i> Key Activities (<%= @project_pinned_count %>)</a></li>
                  <li class="nav-tab"><a id="tasks-link" href="/salesforce/?id=<%=@salesforce_id %>&pid=<%=@project.id%>&actiontype=tasks_tab" class="white-bg"><i class="fa fa-list-ul"></i> Smart Tasks (<%= @project_open_tasks_count %>)</a></li>
                  <li class="nav-tab"><a id="arg-link" href="/salesforce/?id=<%=@salesforce_id %>&pid=<%=@project.id%>&actiontype=arg_tab" class="white-bg"><i class="fa fa-users"></i> Relationship Graph</a></li>
                  <li class="nav-tab"><a id="insights-link" href="/salesforce/?id=<%=@salesforce_id %>&pid=<%=@project.id%>&actiontype=insights_tab" class="white-bg"><i class="fa fa-lightbulb-o"></i> Insights</a></li>
                </ul>
            <%= render 'projects/activities_tab' if @actiontype == "show" %>
            <%= render 'projects/pinned_tab', pinned_activities: @pinned_activities if @actiontype == "pinned_tab" %>
            <%= render 'notifications/project' if @actiontype == "tasks_tab" %>
            <%= render 'projects/arg_tab', project_id: @project.id if @actiontype == "arg_tab" %>
            <%= render 'projects/insights_tab', project_id: @project.id if @actiontype == "insights_tab" %>
           
        </div>
      </div>   
      <% end %>
    </div>
  </div>
</div>

<script>
<% if @actiontype == "show" %>
    /* Pins (same as the one in projects#show */
    $('.best_in_place.pin').on("ajax:success", function(){
        if ($(this).data('activity').is_pinned) {
            // remove from pinned tab
            $(this).data('activity').is_pinned = false;
            var id = $(this).data('activity').id;
            $("tr#pin-"+id).fadeOut(400, function() {$("tr#pin-"+id).remove();});
            $(this).parents('.vertical-timeline-content').children('h3').children('#pinned').hide();
        }
        else {
            // add to pinned tab
            $(this).data('activity').is_pinned = true;
            $(this).parents('.vertical-timeline-content').children('h3').children('#pinned').show();
        }
    });

    /* Toggle Private */
    $('.best_in_place.toggle-private').on('ajax:success', function() {
        if ($(this).data('activity').is_public) {
            $(this).data('activity').is_public = false;
            $(this).parents('.vertical-timeline-content').children('h3').children('#private').show();
        }
        else {
            $(this).data('activity').is_public = true;
            $(this).parents('.vertical-timeline-content').children('h3').children('#private').hide();
        }
    });

    /* Spin the refresh icon to show that refresh is running */
    $('#btn-refresh').click( function () {
        $('.fa.fa-refresh').addClass('fa-spin');
    })

    // Fix best_in_place bug/side-effect that adds paragraph tags to the .html of custom field dropdown lists, causing the value to be displayed awkwardly
    $('.best_in_place').bind('ajax:success', function(){ 
        this.innerHTML = this.innerHTML.replace('\<p\>', '').replace('\<\/p\>', '');
    });

    $(document).ready(function(){
        /* Set the initial state of Account custom fields expandable section to expanded+showing */
        toggleSection($("#stream-account-custom-fields"));
    });
<% end %>

$(document).ready(function(){
});


</script>

<% if @actiontype == "tasks_tab" || @actiontype == "show" %>
<%= javascript_include_tag 'notifications' %>
<% end %>
