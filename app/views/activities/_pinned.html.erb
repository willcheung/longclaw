
<tr id="pin-<%=a.id%>" <% if a.category == Activity::CATEGORY[:Meeting] && Time.zone.at(a.last_sent_date) > Time.current %> class="future-activity" <% end %> >
    <td>
        <% if a.category == Activity::CATEGORY[:Conversation] %>
            <div class="vertical-timeline-icon secondary-bg pinned">
                <i class="fa fa-envelope"></i>
            </div>
        <% elsif a.category == Activity::CATEGORY[:Note] %>
            <div class="vertical-timeline-icon sticky-bg pinned">
                <i class="fa fa-sticky-note"></i>
            </div>
        <% elsif a.category == Activity::CATEGORY[:Meeting] %>
            <div class="vertical-timeline-icon warning-bg pinned">
                <i class="fa fa-calendar"></i>
            </div>
        <% elsif a.category == Activity::CATEGORY[:JIRA] %>
            <div class="vertical-timeline-icon jira-bg pinned">
                <i class="jira-logo"></i>
            </div>
        <% elsif a.category == Activity::CATEGORY[:Zendesk] %>
            <div class="vertical-timeline-icon zd-bg pinned">
                <i class="zd-logo"></i>
            </div>
        <% elsif a.category == Activity::CATEGORY[:Salesforce] %>
            <div class="vertical-timeline-icon salesforce-bg pinned">
                <i class="salesforce-logo"></i>
            </div>
         <% elsif a.category == Activity::CATEGORY[:Basecamp2] %>
            <div class="vertical-timeline-icon basecamp2-bg">
                <i class="basecamp2-logo"></i>
            </div>
        <% elsif a.category == Activity::CATEGORY[:Alert] %>
            <div class="vertical-timeline-icon danger-bg pinned">
                <i class="fa fa-exclamation"></i>
            </div>
        <% end %>
    </td>
    <td <% if a.category == Activity::CATEGORY[:Note] %>style="background-color: #fff7db; margin-left=-3px;"<% end %> class="pinned-content rag-bar<%=a['rag_score']%>">
        <% if a.category == Activity::CATEGORY[:Conversation] %>
        <h3 class="font-bold">
            <%= a.title %>
            <small class="m-l-md font-normal"><%= get_conversation_member_names(a.from, a.to, a.cc) %></small>
            <span id="private" <% if a.is_public %>style="display:none"><% end %><i class="fa fa-lock pull-right" title="Private"></i></span>
        </h3>

        <div class="chat-discussion">
            <% if a.email_messages.size > 1 %>
                <div class="more-messages">
                    <a class="show-more-<%= a.id.to_s %>"><i class="fa fa-plus-square"></i> &nbsp; <%= pluralize((a.email_messages.size - 1), 'older message') %></a>
                </div>
            <% end %>

            <% a.email_messages.each do |m| %>
                <div class="hidden-chat-message-<%= a.id.to_s %>"  <% if a.email_messages.last != m %> style="display:none;" <% end %>>
                    <div class="chat-message <%= is_internal_domain?(m.from[0].address) ? "left" : "right" %>">
                        <%= get_profile_pic(m.from[0].personal, m.from[0].address, "message-avatar") %>
                        <div class="message">
                            <span class="message-author" href="#"> <%= m.from[0].personal %> </span> to <%= get_conversation_member_names([], m.to, m.cc, "All") %>
                            <span class="message-date"><%= Time.zone.at(m.sentDate).strftime("%b %d") %></span>
                            <hr class="message-divider"/>
                            <span class="message-content">
                                <%= if m.content.nil? || m.content.is_a?(String)
                                      simple_format(m.content)
                                    else
                                        simple_format(m.content.body)
                                    end %>
                            </span>
                        </div>
                    </div>
                </div>
            <% end %>

            <div class="col-4-lg action-links">
                <%= best_in_place a, :is_pinned, :as => 'checkbox', :data => {:activity => a}, collection: {false: raw("<a id=\"pin-link\">Pin as Key Activity</a>"), true: raw("<strong><a id=\"pin-link\"><i class=\"fa fa-thumb-tack\"></i> Pinned</a></strong>")}, :class => 'pin' %>
                 &sdot; <a class="comment-link-<%= a.id %>">Comment</a>
                 &sdot;
                    <%= best_in_place a, :is_public, :as => 'checkbox', :data => {:activity => a}, :class => 'toggle-private', collection: {
                      false: raw('<strong><a><i class="fa fa-lock"></i> Private</a></strong>'),
                      true: raw('<a>Mark Private</a>')
                    }  %>
            </div>
        </div>

        <% elsif a.category == Activity::CATEGORY[:Note] %>
        <div class="chat-discussion">
          <div class="col-xs-11 rag-border-color<%=a['rag_status']%>">
            <p class="note-author"><strong><%= get_full_name(a.user) %></strong> wrote:</p>
            <%= simple_format(a.note) %>
            <div class="col-4-lg action-links">
                <%= best_in_place a, :is_pinned, :as => 'checkbox', :data => {:activity => a}, collection: {false: raw("<a id=\"pin-link\">Pin as Key Activity</a>"), true: raw("<strong><a id=\"pin-link\"><i class=\"fa fa-thumb-tack\"></i> Pinned</a></strong>")}, :class => 'pin' %>
                 &sdot; <a class="comment-link-<%= a.id %>">Comment</a>
            </div>
          </div>
        </div>

        <% elsif a.category == Activity::CATEGORY[:Meeting] %>
        <h3 class="font-bold">
            <%= a.title %>
            <span class="m-l-md font-normal"><%= get_calendar_interval(a) %></span>
            <span id="private" <% if a.is_public %>style="display:none"><% end %><i class="fa fa-lock pull-right" title="Private"></i></span>
        </h3>

        <div class="chat-discussion">
            <strong>Meeting Organizer:</strong> <%= a.from[0].personal ? a.from[0].personal : a.from[0].address %>
            <strong class="m-l-md">Attendees:</strong> <%= get_calendar_member_names(a.to) %>

            <div class="col-4-lg action-links">
                <%= best_in_place a, :is_pinned, :as => 'checkbox', :data => {:activity => a}, collection: {false: raw("<a id=\"pin-link\">Pin as Key Activity</a>"), true: raw("<strong><a id=\"pin-link\"><i class=\"fa fa-thumb-tack\"></i> Pinned</a></strong>")}, :class => 'pin' %>
                 &sdot; <a class="comment-link-<%= a.id %>">Comment</a>
                 &sdot;
                    <%= best_in_place a, :is_public, :as => 'checkbox', :data => {:activity => a}, :class => 'toggle-private', collection: {
                      false: raw('<strong><a><i class="fa fa-lock"></i> Private</a></strong>'),
                      true: raw('<a>Mark Private</a>')
                    }  %>
            </div>
        </div>

        <% elsif a.category == Activity::CATEGORY[:Salesforce] %>
            <h3><%= a.title %>
                <small class="m-l-md"><%= a.from[0].personal ? a.from[0].personal : a.from[0].address %></small>
                <span class="message-date">&nbsp;â€”&nbsp;&nbsp;<%= Time.zone.at(a.last_sent_date).strftime("%b %d") %></span>
                <span class="label pull-right"><%= a.email_messages.first["ActivityType"] %></span>
                <span id="private" <% if a.is_public %>style="display:none;"<% end %>><i class="fa fa-lock pull-right" title="Private"></i></span>
            </h3>

            <div class="chat-discussion">
                <div class="row">
                    <div class="col-xs-11">
                        <%= simple_format(a.note) %>
                    </div>
                </div>

                <div class="action-links">
                  <%= best_in_place a, :is_pinned, :as => 'checkbox', :data => {:activity => a}, collection: {false: raw("<a id=\"pin-link\">Pin as Key Activity</a>"), true: raw("<strong><a id=\"pin-link\"><i class=\"fa fa-thumb-tack\"></i> Pinned</a></strong>")}, :class => 'pin' %>
                  &sdot;
                    <%= best_in_place a, :is_public, :as => 'checkbox', :data => {:activity => a}, :class => 'toggle-private', collection: {
                      false: raw('<strong><a><i class="fa fa-lock"></i> Private</a></strong>'),
                      true: raw('<a>Mark Private</a>')
                    }  %>
                  &sdot; <a class="comment-link-<%= a.id %>">Comments (<%= a.comments.size %>)</a>
                  <% if @salesforce_base_URL.present? %>&sdot; <a href="<%= @salesforce_base_URL + "/" + a.backend_id %>" target="_blank">View in Salesforce <i class="fa fa-external-link"></i></a><% end %>
                </div>
            </div> <!-- chat discussion -->
        <% elsif a.category == Activity::CATEGORY[:Basecamp2] %>
            <h3><%= a.title %>
              <small class="m-l-md"><%= get_conversation_member_names(a.from, a.to, a.cc) %></small>
              <span class="label pull-right"></span>                
              <span id="private" <% if a.is_public %>style="display:none;"<% end %>><i class="fa fa-lock pull-right" title="Private"></i></span>
              <span id="pinned" <% if !a.is_pinned %>style="display:none;"<% end %>><i class="fa fa-thumb-tack pull-right" title="Pinned"></i></span>
            </h3>
            <div class="chat-discussion">
                <% if a.email_messages.length > 1 %>
                  <div class="more-messages">
                    <a class="show-more-<%= a.id.to_s %>"><i class="fa fa-plus-square"></i> &nbsp; <%= pluralize(a.email_messages.length - 1, 'older comment') %> on BaseCamp2</a>
                  </div>
                <% end %>
                <% a.email_messages.reverse.each_with_index do |c, i| %>
                  <div class="hidden-message-filter hidden-chat-message-<%= a.id.to_s %>" <% unless a.email_messages.size - 1 == i %> style="display:none;" <% end %> >
                      <% if c.eventable %>
                      <div class="chat-message <%= is_internal_domain?(c.email_address) ? "left" : "right" %>">
                          <%= get_profile_pic(c.creator.name, c.creator.name, "message-avatar") %>
                          <div class="message">
                            <% if c.action == 'commented on'%>
                              <span class="message-author" href="#"> <%=c.creator.name %> </span> added a comment - <%=c.updated_at.to_date %>
                              <span class="message-content"><%= simple_format(c.excerpt) %></span>
                            <% else %>
                              <span class="message-author" href="#"> <%=c.creator.name %> </span> created action - <%=c.updated_at.to_date %>
                              <span class="message-content"><%= simple_format(c.summary) %></span>
                              <%end%>
                          </div>
                      </div>
                      <%end%>
                  </div>
                  <% end %>
                  <div class="action-links">
                        <%= best_in_place a, :is_pinned, :as => 'checkbox', :data => {:activity => a}, collection: {false: raw("<a id=\"pin-link\">Pin as Key Activity</a>"), true: raw("<strong><a id=\"pin-link\"><i class=\"fa fa-thumb-tack\"></i> Pinned</a></strong>")}, :class => 'pin' %>
                      
                        &sdot; <a class="comment-link-<%= a.id %>">Comments (<%= a.comments.size %>)</a>
                        &sdot; <a href="<%=a.email_messages.first.html_url%>" target="_blank">View in BaseCamp2 <i class="fa fa-external-link"></i></a>
                  </div><!-- action-links -->
            </div> <!-- chat discussion -->

        <% elsif a.category == Activity::CATEGORY[:JIRA] %>

        <h3 class="font-bold">
            <%= a.title %>
            <small class="m-l-md font-normal"><%= get_conversation_member_names(a.from, a.to, a.cc) %></small>
            <span class="label pull-right"><%= a.email_messages.first.issue.fields.status.name %></span>
            <span id="private" <% if a.is_public %>style="display:none;"<% end %>><i class="fa fa-lock pull-right" title="Private"></i></span>
        </h3>

        <div class="chat-discussion">
            <div><strong>Description:</strong> <%= a.note %></div>
            <% if a.email_messages.first.issue.fields.comment.total > 1 %>
                <div class="more-messages">
                    <a class="show-more-<%= a.id.to_s %>"><i class="fa fa-plus-square"></i> &nbsp; <%= pluralize(a.email_messages.first.issue.fields.comment.total - 1, 'older comment') %> on JIRA</a>
                </div>
            <% end %>

            <% a.email_messages.first.issue.fields.comment.comments.each_with_index do |c, i| %>
                <div class="hidden-message-filter hidden-chat-message-<%= a.id.to_s %>" <% unless a.email_messages.first.issue.fields.comment.total - 1 == i %> style="display:none;" <% end %> >
                    <div class="chat-message left">
                        <%= get_profile_pic(c.author.displayName, c.author.emailAddress, "message-avatar") %>
                        <div class="message">
                            <span class="message-author" href="#"> <%=c.author.displayName %> </span> added a comment - <%= time_ago_in_words(c.updated.to_time) %> ago
                            <span class="message-content"><%= simple_format(c.body) %></span>
                        </div>
                    </div>
                </div>
            <% end %>
            <div class="action-links">
              <%= best_in_place a, :is_pinned, :as => 'checkbox', :data => {:activity => a}, collection: {false: raw("<a id=\"pin-link\">Pin as Key Activity</a>"), true: raw("<strong><a id=\"pin-link\"><i class=\"fa fa-thumb-tack\"></i> Pinned</a></strong>")}, :class => 'pin' %>
              &sdot;
                <%= best_in_place a, :is_public, :as => 'checkbox', :data => {:activity => a}, :class => 'toggle-private', collection: {
                  false: raw('<strong><a><i class="fa fa-lock"></i> Private</a></strong>'),
                  true: raw('<a>Mark Private</a>')
                }  %>
              &sdot; <a class="comment-link-<%= a.id %>">Comments (<%= a.comments.size %>)</a>
              &sdot; <a href="<%= a.email_messages.first.issue.self.sub(/(?<=atlassian\.net\/).*/, "browse/" + a.email_messages.first.issue['key']) %>" target="_blank">View in JIRA <i class="fa fa-external-link"></i></a>
            </div>
        </div>
        <% elsif a.category == Activity::CATEGORY[:Zendesk] %>
        <h3 class="font-bold">
            <%= a.title %>
            <small class="m-l-md font-normal"><%= get_conversation_member_names(a.from, a.to, a.cc) %></small>
            <span class="label pull-right"><%= a.email_messages.first.status %></span>
            <span id="private" <% if a.is_public %>style="display:none;"<% end %>><i class="fa fa-lock pull-right" title="Private"></i></span>
        </h3>

        <div class="chat-discussion">
            <% if a.email_messages.first.comments.length > 1 %>
                <div class="more-messages">
                    <a class="show-more-<%= a.id.to_s %>"><i class="fa fa-plus-square"></i> &nbsp; <%= pluralize(a.email_messages.first.comments.length - 1, 'older comment') %> on Zendesk</a>
                </div>
            <% end %>

            <% a.email_messages.first.comments.each_with_index do |c, i| %>
                <div class="hidden-message-filter hidden-chat-message-<%= a.id.to_s %>" <% unless a.email_messages.first.comments.length - 1 == i %> style="display:none;" <% end %> >
                    <div class="chat-message left">
                        <%= get_profile_pic(c.author, c.author, "message-avatar") %>
                        <div class="message">
                            <span class="message-author" href="#"> <%=c.author %> </span> added a comment - <%= c.created_at %> ago
                            <span class="message-content"><%= simple_format(c.text) %></span>
                        </div>
                    </div>
                </div>
            <% end %>
            <div class="action-links">
              <%= best_in_place a, :is_pinned, :as => 'checkbox', :data => {:activity => a}, collection: {false: raw("<a id=\"pin-link\">Pin as Key Activity</a>"), true: raw("<strong><a id=\"pin-link\"><i class=\"fa fa-thumb-tack\"></i> Pinned</a></strong>")}, :class => 'pin' %>
              &sdot;
                <%= best_in_place a, :is_public, :as => 'checkbox', :data => {:activity => a}, :class => 'toggle-private', collection: {
                  false: raw('<strong><a><i class="fa fa-lock"></i> Private</a></strong>'),
                  true: raw('<a>Mark Private</a>')
                }  %>
              &sdot; <a class="comment-link-<%= a.id %>">Comments (<%= a.comments.size %>)</a>
              &sdot; <a href="<%= a.email_messages.first.link %>" target="_blank">View in JIRA <i class="fa fa-external-link"></i></a>
            </div>
        </div>

        <% elsif a.category == Activity::CATEGORY[:Alert] %>
            <h3 class="font-bold">
                Alert: <%= a.title %>
           </h3>

            <div class="chat-discussion">
                <div> <%= a.note %></div>

                <div class="action-links">
                  <%= best_in_place a, :is_pinned, :as => 'checkbox', :data => {:activity => a}, collection: {false: raw("<a id=\"pin-link\">Pin as Key Activity</a>"), true: raw("<strong><a id=\"pin-link\"><i class=\"fa fa-thumb-tack\"></i> Pinned</a></strong>")}, :class => 'pin' %>
                  &sdot; <a class="comment-link-<%= a.id %>">Comments (<%= a.comments.size %>)</a>
                </div>
            </div>

        <% end %>

        <div class="content-footer footer-<%= a.id %>">

            <% a.comments.each do |c| %>
                <%= render "comments/comment", :c => c %>
            <% end %>

            <div class="social-comment form-<%= a.id %> row" style="display:none;">
                <div class="col-sm-1">
                    <%= get_profile_pic(get_full_name(current_user), current_user.email, "") %>
                </div>
                <div class="col-sm-11">
                    <%= render 'comments/form', :activity => a %>
                </div>
            </div>
        </div>
    </td>
</tr>

<%= render 'activities/show_more_js', :a => a %>
