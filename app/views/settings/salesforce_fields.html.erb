<head>
  <style>
    .highlight {
      background-color:greenyellow;"
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 42px;
      height: 23px;
    }

    .switch input {display:none;}

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      -webkit-transition: .4s;
      transition: .4s;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 19px;
      width: 19px;
      left: 2px;
      top: 2px;
      background-color: white;
      -webkit-transition: .4s;
      transition: .4s;
    }

    input:checked + .slider {
      background-color: #3c8dc5;
    }

    input:focus + .slider {
      box-shadow: 0 0 2px #666;
    }

    input:checked + .slider:before {
      -webkit-transform: translateX(19px);
      -ms-transform: translateX(19px);
      transform: translateX(19px);
    }

    /* Rounded sliders - solid base */
    .slider.round {
      border-radius: 24px;
    }

    .slider.round:before {
      border-radius: 50%;
    }
  </style>
</head>

<div class="row wrapper border-bottom white-bg page-heading">
    <div class="col-lg-10">
        <h2>Salesforce Integration</h2>
        <ol class="breadcrumb">
            <li>
                <a href="<%= root_path %>">Home</a>
            </li>
            <li>
                <a href="<%= settings_path%>">Settings</a>
            </li>
            <li class="active">
                <strong>Salesforce Integration</strong>
            </li>
        </ol>
    </div>
</div>

<div class="wrapper wrapper-content animated fadeInRight">
    <div class="ibox float-e-margins">
        <div class="ibox-content">
            <% if @salesforce_user.nil?%> 
              <a class="btn btn-primary btn-sm"  style="font-size:12px;" href="<%=user_omniauth_authorize_url(:salesforce)%> ">Login to Salesforce</a>
              <a class="btn btn-primary btn-sm"  style="font-size:12px;" href="/users/auth/salesforcesandbox">Login to Salesforce Sandbox</a> <br>
              Must be a Salesforce admin. Please contact <a href="mailto:support@contextsmith.com?subject=Salesforce%20Integration%20Setup" target="_blank">support@contextsmith.com</a> for setup instructions.
            <% else %>
              <!-- Salesforce nav to Account / Opportunities -->
              <nav class="navbar navbar-default">
                  <!-- Collect the nav links, forms, and other content for toggling -->
                  <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                    <ul class="nav navbar-nav">
                      <li><a href="<%= settings_salesforce_path %>">Step 1: Map Accounts</a></li>
                      <li><a href="<%= settings_salesforce_opportunities_path %>">Step 2: Map Opportunities</a></li>
                      <li><a href="<%= settings_salesforce_activities_path %>">Step 3: Map Activities</a></li>
                      <li class="active"><a href="<%= settings_salesforce_fields_path %>">Step 4: Map Fields</a></li>
                    </ul>
                  </div>
              </nav>
              <div id="filter_switch" style="padding:0.5em 0 0;margin-bottom:1em;border-bottom:1px dotted grey;">
                <label class="switch">
                  <input type="checkbox" onclick="javascript:handle_SF_Custom_Fields_Only_filter_switch_click(this);" <% if params[:sf_custom_fields_only] == "true" %> checked <% end %>
                  />
                  <div class="slider round"></div>
                  <span style="font-weight:normal;position:absolute;top:3px;left:48px;">Salesforce&nbsp;custom&nbsp;fields&nbsp;filter&nbsp;<% if params[:sf_custom_fields_only] == "true" %>(on)<% else %>(off)<% end %></span>
                  <i id="filter_switch_refresh" class='fa fa-refresh' style='display:none;font-weight:normal;position:absolute;top:5px;left:255px'></i>
                </label>
              </div>
              <div class="row col-lg-12" style="margin-right:0; margin-left:0; padding:0px; display: inline"> 
                <table style="min-width:545px; width:100%">
                  <tbody>
                    <tr>
                      <td><h2 style="display:inline">Account</h2></td>
                      <td style="margin-right:-1em;padding:0;float:right">
                        <a href="#" style="border-bottom:2px solid red"><i class="fa fa-exclamation"></i> Clear all account mapping</a>&nbsp;&nbsp;
                        <div style="min-width:18em;width:18em; padding:0px;margin:0px;display:inline-block">
                          <span id="salesforce-refresh-accounts" class="btn btn-sm btn-primary btn-outline"> <i class="fa fa-refresh"></i> Refresh ContextSmith Accounts</span>
                          <i class="fa fa-question-circle text-primary"data-toggle="tooltip" data-placement="top" data-original-title="Retrieve values from Salesforce fields and load into ContextSmith fields."></i>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <table class="table table-striped table-bordered table-hover responsive no-wrap" id="users-table" cellspacing="0">
                  <thead>
                      <tr>
                          <th style="padding-top:15px;min-width:13em;max-width:20em">ContextSmith Account Field</th>
                          <th style="padding-top:15px;min-width:8em;max-width:15em;border-right-style: 1px solid black;">Field Data Type</th>
                          <th style="padding-top:15px;min-width:13em;max-width:20em">Salesforce Account Field</th>
                          <th style="padding-top:15px;min-width:8em;max-width:15em"></th>
                      </tr>
                  </thead>
                  <tbody>
                    <% if @cs_account_custom_fields.empty? %>
                      <tr>
                        <td>No ContextSmith Account custom fields.  <a href='settings_custom_fields_path'>Click here to add some!</a></td><td></td><td></td><td></td><td></td><td></td>
                      </tr>
                    <% else %>
                      <% @cs_account_custom_fields.each.with_index do |cf,i| %>
                        <tr>
                          <td><%= cf.name %></td>
                          <td><%= cf.data_type %></td>
                          <td> <!-- salesforce_field_name -->
                            <%= best_in_place cf, :salesforce_field, :as => :select, :collection => @sf_fields[:sf_account_fields], :class => 'btn btn-default btn-sm fa-caret-down salesforce-account-field-name', :style => "color:#DDD;", :customfield_id => "#{cf.id}" %>
                          </td>
                          <td>
                             <!-- <% if not @sf_fields[:sf_account_fields_metadata][cf.salesforce_field].nil? %>
                                <%= @sf_fields[:sf_account_fields_metadata][cf.salesforce_field]["type"] %>
                              <% end %> -->
                          </td>
                        </tr>
                      <% end %>
                    <% end %>
                  </tbody>
              </table>

              <div class="row col-lg-12" style="margin-right:0; margin-left:0; padding:0px; display: inline"> 
                <table style="min-width:545px; width:100%">
                  <tbody>
                    <tr>
                    <td><h2 style="display:inline">Stream</h2></td>
                    <td style="margin-right:-1.5em;padding:0;float:right">
                      <a href="#" style="border-bottom:2px solid red"><i class="fa fa-exclamation"></i> Clear all stream mapping</a>&nbsp;&nbsp;
                      <div style="min-width:18em;width:18em; padding:0px;margin:0px;display:inline-block">
                        <span id="salesforce-refresh-projects" class="btn btn-sm btn-primary btn-outline"> <i class="fa fa-refresh"></i> Refresh ContextSmith Streams</span>
                        <i class="fa fa-question-circle text-primary"data-toggle="tooltip" data-placement="top" data-original-title="Retrieve values from Salesforce fields and load into ContextSmith fields."></i>
                      </div>
                    </td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <table class="table table-striped table-bordered table-hover responsive no-wrap" id="users-table" cellspacing="0">
                  <thead>
                      <tr>
                          <th style="padding-top:15px;min-width:13em;max-width:20em">ContextSmith Stream Field</th>
                          <th style="padding-top:15px;min-width:8em;max-width:15em;border-right-style: 1px solid black;">Field Data Type</th>
                          <th style="padding-top:15px;min-width:13em;max-width:20em">Salesforce Opportunity Field</th>
                          <th style="padding-top:15px;min-width:8em;max-width:15em"></th>
                      </tr>
                  </thead>
                  <tbody>
                    <% if @cs_stream_custom_fields.empty? %>
                      <tr>
                        <td>No ContextSmith Stream custom fields.  <a href='/settings/custom_fields?entity_type=Stream'>Click here to add some!</a></td><td></td><td></td><td></td><td></td><td></td>
                      </tr>
                    <% else %>
                      <% @cs_stream_custom_fields.each.with_index do |cf,i| %>
                        <tr>
                          <td><%= cf.name %></td>
                          <td><%= cf.data_type %></td>
                          <td> <!-- salesforce_field_name -->
                            <%= best_in_place cf, :salesforce_field, :as => :select, :collection => @sf_fields[:sf_opportunity_fields], :class => 'btn btn-default btn-sm fa-caret-down salesforce-opportunity-field-name', :style => "color:#DDD;", :customfield_id => "#{cf.id}" %>
                          </td>
                          <td>
                            <!-- <% if not @sf_fields[:sf_opportunity_fields_metadata][cf.salesforce_field].nil? %>
                              <%= @sf_fields[:sf_opportunity_fields_metadata][cf.salesforce_field]["type"] %>
                            <% end %> -->
                          </td>
                        </tr>
                      <% end %>
                    <% end %>
                  </tbody>
              </table>
            <%end%>
        </div>
    </div>
</div>

<script>
  function handle_SF_Custom_Fields_Only_filter_switch_click(checkbox) {
      $("#filter_switch").css("pointer-events", "none");  //disable extra clicks on toggle switch

      document.getElementById('filter_switch_refresh').style.display = "inline";
      document.getElementById('filter_switch_refresh').className = document.getElementById('filter_switch_refresh').className + " fa-spin";

      if (checkbox.checked)
          window.location.replace("/settings/salesforce_fields?sf_custom_fields_only=true");
      else
          window.location.replace("/settings/salesforce_fields");
  };

  $('#salesforce-refresh-accounts').click(function() {
      $.ajax('/salesforce_fields_refresh?entity_type=accounts', {
          async: true,
          method: "POST",
          beforeSend: function () {
              $('#salesforce-refresh-accounts').removeClass('highlight');
              $('#salesforce-refresh-accounts').html("<i class='fa fa-refresh'></i> Refresh ContextSmith Accounts")
              $('#salesforce-refresh-accounts .fa.fa-refresh').addClass('fa-spin');
          },
          complete: function() {
              $('#salesforce-refresh-accounts .fa.fa-refresh').removeClass('fa-spin');
              $('#salesforce-refresh-accounts').addClass('highlight');
              $('#salesforce-refresh-accounts').html("✓ Refresh ContextSmith Accounts");
          }
      });
  });

  $('#salesforce-refresh-projects').click(function() {
      $.ajax('/salesforce_fields_refresh?entity_type=projects', {
          async: true,
          method: "POST",
          beforeSend: function () {
              $('#salesforce-refresh-projects').removeClass('highlight');
              $('#salesforce-refresh-projects').html("<i class='fa fa-refresh'></i> Refresh ContextSmith Accounts")
              $('#salesforce-refresh-projects .fa.fa-refresh').addClass('fa-spin');
          },
          complete: function() {
              $('#salesforce-refresh-projects .fa.fa-refresh').removeClass('fa-spin');
              $('#salesforce-refresh-projects').addClass('highlight');
              $('#salesforce-refresh-projects').html("✓ Refresh ContextSmith Streams");
          }
      });
  });

  $('.salesforce-account-field-name').change(function() {
      $('#salesforce-refresh-accounts').removeClass('highlight');
      $('#salesforce-refresh-accounts').html("<i class='fa fa-refresh'></i> Refresh ContextSmith Accounts")
      //console.log("Salesforce-account-field-name for customfield id=" + $(this).attr("customfield_id") + " was changed.");
  });

  $('.salesforce-opportunity-field-name').change(function() {
      $('#salesforce-refresh-projects').removeClass('highlight');
      $('#salesforce-refresh-projects').html("<i class='fa fa-refresh'></i> Refresh ContextSmith Streams")
      //console.log("Salesforce-account-field-name for customfield id=" + $(this).attr("customfield_id") + " was changed.");
  });
</script>