<div class="row wrapper border-bottom white-bg page-heading">
    <div class="col-lg-10">
        <h2>Salesforce Integration</h2>
        <ol class="breadcrumb">
            <li>
                <a href="<%= root_path %>">Home</a>
            </li>
            <li>
                <a href="<%= settings_path%>">Settings</a>
            </li>
            <li class="active">
                <strong>Salesforce Integration</strong>
            </li>
        </ol>
    </div>
</div>

<div class="wrapper wrapper-content animated fadeInRight">
    <div class="ibox float-e-margins">
        <div class="ibox-content">
            <% if @salesforce_user.nil?%> <a class="btn btn-primary btn-sm"  style="font-size:12px;" href="<%=user_omniauth_authorize_url(:salesforce)%> ">Login to Salesforce</a>
            <a class="btn btn-primary btn-sm"  style="font-size:12px;" href="/users/auth/salesforcesandbox">Login to Salesforce Sandbox</a> <br>
            Must be a Salesforce admin. Please contact <a href="mailto:support@contextsmith.com?subject=Salesforce%20Integration%20Setup" target="_blank">support@contextsmith.com</a> for setup instructions.
            <% else %>
              <!-- Salesforce nav to Account / Opportunities -->
              <nav class="navbar navbar-default">
                  <!-- Collect the nav links, forms, and other content for toggling -->
                  <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                    <ul class="nav navbar-nav">
                      <li><a href="<%= settings_salesforce_path %>">Step 1: Map Accounts</a></li>
                      <li><a href="<%= settings_salesforce_opportunities_path %>">Step 2: Map Opportunities</a></li>
                      <li class="active"><a href="<%= settings_salesforce_activities_path %>">Step 3: Map Activities</a></li>
                    </ul>
                  </div>
              </nav>

              <table class="table table-striped table-bordered table-hover responsive no-wrap" id="users-table" cellspacing="0" width="100%">
                  <thead>
                      <tr>
                          <th style="padding-top:15px;">ContextSmith Stream</th>
                          <th>
                            <div style="padding-top:15px; display: inline; margin-right:5px;">Salesforce Activities</div>                              
                            <div id="salesforce-activity-refresh" class="btn btn-sm btn-primary btn-outline "> <i class="fa fa-refresh"></i> Refresh Activities</div>
                            <i class="fa fa-question-circle text-primary"data-toggle="tooltip" data-placement="top" data-original-title="Retrieve latest Activities from Salesforce."></i>
                          </th>
                      </tr>
                  </thead>
                  <tbody>
                    <% @streams.each do |s| %>
                      <tr>
                        <td class="col-lg-5"><a href="<%= project_path(s) %>"><%= s.name %></a></td>
                        <% if s.salesforce_opportunity.nil? %>
                          <% if s.account.salesforce_accounts.empty? %>
                            <td class="col-lg-7">Not linked</td>  
                          <% else %>
                            <td class="col-lg-7">Linked to SFDC Account: <%= s.account.salesforce_accounts.map{|n| n.salesforce_account_name}.join(', ') %></td>
                          <% end %>
                        <% else %>
                          <td class="col-lg-7">Linked to SFDC Opportunity: <%= s.salesforce_opportunity.name %></td>
                        <% end %>
                      </tr>
                    <% end %>
                  </tbody>
              </table>
            <%end%>
        </div>
    </div>
</div>

<script>

$('#salesforce-activity-refresh').click(function(){
    $.ajax('/salesforce_activities_refresh', {
        async: true,
        method: "POST",
        beforeSend: function () {
            $('#salesforce-activity-refresh .fa.fa-refresh').addClass('fa-spin');
        },
        complete: function() {
            $('#salesforce-activity-refresh .fa.fa-refresh').removeClass('fa-spin');
        }
    });
});

</script>